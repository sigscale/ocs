<link rel="import" href="polymer/polymer.html">
<link rel="import" href="i18n-msg/i18n-msg.html">
<link rel="import" href="i18n-msg/i18n-msg-behavior.html">
<link rel="import" href="iron-ajax/iron-ajax.html">
<link rel="import" href="iron-collapse/iron-collapse.html">
<link rel="import" href="paper-dialog/paper-dialog.html">
<link rel="import" href="paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="paper-listbox/paper-listbox.html">
<link rel="import" href="paper-toolbar/paper-toolbar.html">
<link rel="import" href="paper-input/paper-input.html">
<link rel="import" href="paper-button/paper-button.html">
<link rel="import" href="paper-tooltip/paper-tooltip.html">
<link rel="import" href="paper-toggle-button/paper-toggle-button.html" >
<link rel="import" href="paper-toast/paper-toast.html">
<link rel="import" href="paper-styles/color.html">
<link rel="import" href="paper-date-picker/paper-date-picker.html">

<dom-module id="sig-pro-add">
	<style is="custom-style">
		paper-dialog {
			overflow: auto;
		}
		paper-item {
			padding-right: 10px;
		}
		paper-toolbar{
			margin-top: 0px;
			color: white;
			background-color: #bc5100;
		}
		.add-button {
			background-color: var(--paper-lime-a700);
			color: black;
			width: 8em;
		}
		.cancel-button {
			color: black;
		}
	</style>
	<template>
		<paper-dialog id="addProductModal" modal>
			<paper-toolbar>
				<paper-tabs selected="{{selected}}">
					<paper-tab id="offer-add">
						<h2>Offering</h2>
					</paper-tab>
					<paper-tab id="price-add">
						<h2>Prices</h2>
					</paper-tab>
					<paper-tab id="alt-add">
						<h2>Alterations</h2>
					</paper-tab>
				</paper-tabs>
			</paper-toolbar>
			<iron-pages selected="{{selected}}">
			<div id="addOff-tab">
				<div>
					<paper-input id="addOff1"
							class="name"
							name="name"
							label="Name"
							onfocus="endDatePickOff.hide(); startDatePickOff.hide();">
					</paper-input>
					<paper-input id="addOff2"
							class="description"
							name="description"
							label="Description"
							onfocus="endDatePickOff.hide(); startDatePickOff.hide();">
					</paper-input>
					<iron-collapse id="startDatePickOff">
						<paper-date-picker id="startOff3" date="{{pickstart}}">
						</paper-date-picker>
					</iron-collapse>
					<paper-input id="addOff3"
							value="[[startDateOffer]]"
							name="startDateOffer"
							label="start Date"
							onfocus="endDatePickOff.hide(); startDatePickOff.show();">
					</paper-input>
					<iron-collapse id="endDatePickOff">
						<paper-date-picker id="endOff3" date="{{pickend}}">
						</paper-date-picker>
					</iron-collapse>
					<paper-input id="addOff4"
							value="[[endDateOffer]]"
							name="endDateOffer"
							label="end Date"
							onfocus="startDatePickOff.hide(); endDatePickOff.show();">
					</paper-input>
				</div>
				<div class="buttons">
					<paper-button dialog-confirm raised
							class="add-button"
							on-tap="addOffer">
								Submit
					</paper-button>
					<paper-button dialog-dismiss
							class="cancel-button"
							on-tap="addProductModal.close()">
								cancel
					</paper-button>
				</div>
			</div>
			<div id=addPrice-tab>
				<div>
					<datalist id="price">
						<template is="dom-repeat" items="[[prices]]">
							<option value="{{item.name}}" />
						</template>
					</datalist>
					<paper-input id="priceName" 
							list="price"
							label="Name"
							on-change="updateDialog"
							onfocus="endDatePickPrice.hide(); startDatePickPrice.hide();">
					</paper-input>
					<paper-input id="addPriceDes"
							class="description"
							name="description"
							label="Description"
							onfocus="endDatePickPrice.hide(); startDatePickPrice.hide();">
					</paper-input>
					<iron-collapse id="startDatePickPrice">
						<paper-date-picker id="addPriceStart" date="{{pickstart}}" headingFormat="dd, MMM D">
						</paper-date-picker>
					</iron-collapse>
					<paper-input id="priceStartDate"
							value="[[startDatePrice]]"
							name="startDatePrice"
							label="Start Date"
							onfocus="endDatePickPrice.hide(); startDatePickPrice.show();">
					</paper-input>
					<iron-collapse id="endDatePickPrice">
						<paper-date-picker id="addPriceEnd" date="{{pickend}}">
						</paper-date-picker>
					</iron-collapse>
					<paper-input id="priceEndDate"
							value="[[endDatePrice]]"
							name="endDatePrice"
							label="End Date"
							onfocus="startDatePickPrice.hide(); endDatePickPrice.show();">
					</paper-input>
					<paper-dropdown-menu id="addPrice1drop"
							label="Price Type"
							on-selected-item-changed="checkRecure"
							onfocus="endDatePickPrice.hide(); startDatePickPrice.hide();">
						<paper-listbox
								id="addPrice1"
								slot="dropdown-content"
								class="dropdown-content"
								selected="2">
							<paper-item>
								Recurring
							</paper-item>
							<paper-item>
								One Time
							</paper-item>
							<paper-item>
								Usage
							</paper-item>
						</paper-listbox>
					</paper-dropdown-menu>
					<paper-dropdown-menu id="addPrice2drop"
							label="Units"
							on-selected-item-changed="checkUnit"
							onfocus="endDatePickPrice.hide(); startDatePickPrice.hide();">
						<paper-listbox
								id="addPrice2"
								slot="dropdown-content"
								class="dropdown-content"
								selected="0">
							<paper-item>
								Bytes	
							</paper-item>
							<paper-item>
								Cents
							</paper-item>
							<paper-item>
								Seconds
							</paper-item>
							<paper-item>
								Megabytes (MB)
							</paper-item>
							<paper-item>
								Gigabytes (GB)
							</paper-item>
						</paper-listbox>
					</paper-dropdown-menu>
					<paper-input id="addPriceSize"
							class="size"
							name="size"
							type="number"
							label="Unit Size"
							value=1
							onfocus="endDatePickPrice.hide(); startDatePickPrice.hide();">
					</paper-input>
					<paper-input id="addPrice3"
							class="amount"
							name="amount"
							type="number"
							label="Amount"
							value=0
							onfocus="endDatePickPrice.hide(); startDatePickPrice.hide();">
					</paper-input>
					<paper-input id="addPrice4"
							class="currency"
							name="currency"
							label="Currency"
							onfocus="endDatePickPrice.hide(); startDatePickPrice.hide();">
					</paper-input>
					<paper-dropdown-menu id="addPrice5drop"
							label="Period"
							onfocus="endDatePickPrice.hide(); startDatePickPrice.hide();">
						<paper-listbox
								id="addPrice5"
								slot="dropdown-content"
								class="dropdown-content"
								selected="2">
							<paper-item>
								Daily
							</paper-item>
							<paper-item>
								Weekly
							</paper-item>
							<paper-item>
								Monthly
							</paper-item>
							<paper-item>
								Yearly
							</paper-item>
						</paper-listbox>
					</paper-dropdown-menu>
					<paper-dropdown-menu
							label="Alterations">
						<paper-listbox
								id="addPriceDrop"
								slot="dropdown-content"
								class="dropdown-content">
							<template is="dom-repeat" items="[[alterations]]">
								<paper-item>
									{{item.name}}
								</paper-item>
							</template>
						</paper-listbox>
					</paper-dropdown-menu>
				</div>
				<div class="buttons">
					<paper-button raised
							class="add-button"
							on-tap="addPrice">
								Add		
					</paper-button>
					<paper-button dialog-dismiss
							class="cancel-button"
							on-click="addProductModal.close()">
								cancel
					</paper-button>
				</div>
			</div>
			<div id="add-Alt-tab">
				<div>
					<datalist id="alts">
						<template is="dom-repeat" items="[[alterations]]">
							<option value="{{item.name}}" />
						</template>
					</datalist>
					<paper-input id="addAlt1" 
							list="alts" 
							label="Name" 
							on-change="updateDialog">
					</paper-input>
					<paper-input id="descAlt2"
							class="description"
							name="description"
							label="Description"
							onfocus="endDatePick.hide(); startDatePick.hide();">
					</paper-input>
					<iron-collapse id="startDatePick">
						<paper-date-picker id="startAlt3" date="{{pickstart}}">
						</paper-date-picker>
					</iron-collapse>
					<paper-input id="startAlt2"
							value="[[startdate]]"
							name="startdate"
							label="Start Date"
							onfocus="endDatePick.hide(); startDatePick.show();">
					</paper-input>
					<iron-collapse id="endDatePick">
						<paper-date-picker id="endAlt3" date="{{pickend}}">
						</paper-date-picker>
					</iron-collapse>
					<paper-input id="endAlt2"
							value="{{enddate}}"
							name="terminationDate"
							label="End Date"
							onfocus="startDatePick.hide(); endDatePick.show();">
					</paper-input>
					<paper-dropdown-menu
							label="Price Type"
							onfocus="endDatePick.hide(); startDatePick.hide();">
						<paper-listbox
								id="typeAlt3"
								slot="dropdown-content"
								class="dropdown-content"
								selected="2">
							<paper-item>
								Recurring
							</paper-item>
							<paper-item>
								One Time
							</paper-item>
							<paper-item>
								Usage
							</paper-item>
						</paper-listbox>
					</paper-dropdown-menu>
					<paper-dropdown-menu
							label="Units">
						<paper-listbox
								id="addUnitDrop"
								slot="dropdown-content"
								class="dropdown-content"
								selected="0">
								<paper-item>
									Bytes	
								</paper-item>
								<paper-item>
									Cents
								</paper-item>
								<paper-item>
									Seconds
								</paper-item>
								<paper-item>
									Megabytes (MB)
								</paper-item>
								<paper-item >
									Gigabytes (GB)
								</paper-item>
						</paper-listbox>
					</paper-dropdown-menu>
					<paper-input id="sizeAlt3"
							class="size"
							name="size"
							label="Unit Size"
							type="number"
							onfocus="endDatePick.hide(); startDatePick.hide();">
					</paper-input>
					<paper-input id="amountAlt3"
							class="amount"
							name="amount"
							label="Amount"
							type="number"
							onfocus="endDatePick.hide(); startDatePick.hide();">
					</paper-input>
				</div>
				<div class="buttons">
					<paper-button raised
							class="add-button"
							on-tap="addAlteration">
								Add
					</paper-button>
					<paper-button dialog-dismiss
							class="cancel-button"
							on-click="addProductModal.close()">
								cancel
					</paper-button>
				</div>
			</div>
		</paper-dialog>
		<iron-ajax
				id="productAddAjax"
				url="/catalogManagement/v1/productOffering"
				method = "POST"
				content-type="application/json"
				on-loading-changed="_onLoadingChanged"
				on-response="productAddResponse"
				handle-as="json">
		</iron-ajax>
	</template>
	<script>
		Polymer ({
			is: 'sig-pro-add',
			behaviors: [i18nMsgBehavior],
			properties: {
				alterations: {
					type: Array,
					value: function() {
						return [];
					}
				},
				prices: {
					type: Array,
					value: function() {
						return [];
					}
				},
				selected: {
					type: Number,
					value: 0
				},
				startdate: {
					type: String,
					value: ""
				},
				startDateOffer: {
					type: String,
					value: ""
				},
				startDatePrice: {
					type: String,
					value: ""
				},
				enddate: {
					type: String,
					value: ""
				},
				endDateOffer: {
					type: String,
					value: ""
				},
				endDatePrice: {
					type: String,
					value: ""
				},
				pickstart: {
					observer: 'pickStartDate'
				},
				pickend: {
					observer: 'pickEndDate'
				},
			},
			pickStartDate: function(date) {
				if (this.$.startDatePick.opened) {
					var m = moment(date);
					this.startdate = m.format('YYYY-MM-DD'); 
				} else if (this.$.startDatePickOff.opened) {
					var m = moment(date);
					this.startDateOffer = m.format('YYYY-MM-DD');
				} else if (this.$.startDatePickPrice.opened) {
					var p = moment(date);
					this.startDatePrice = p.format('YYYY-MM-DD');
				}
			},
			pickEndDate: function(date) {
				if (this.$.endDatePick.opened) {
					var m = moment(date);
					this.enddate = m.format('YYYY-MM-DD');
				} else if (this.$.endDatePickOff.opened) {
					var m = moment(date);
					this.endDateOffer = m.format('YYYY-MM-DD'); 
				} else if (this.$.endDatePickPrice.opened) {
					var p = moment(date);
					this.endDatePrice = p.format('YYYY-MM-DD');
				}
			},
			updateDialog: function() {
				function checkName(alts) {
					return alts.name == this.addAlt1.value; 
				}
				var index = this.alterations.findIndex(checkName);
				if (index == -1) {
					this.$.descAlt2.value = null;
					this.$.typeAlt3.value = null;
					this.$.sizeAlt3.value = null;
					this.$.amountAlt3.value = null;
				} else {
					this.$.descAlt2.value = this.alterations[index].description;
					this.$.startAlt2.value = this.alterations[index].startdate;
					this.$.endAlt2.value = this.alterations[index].terminationDate;
					this.$.typeAlt3.value = this.alterations[index].type;
					this.$.addUnitDrop.value = this.alterations[index].units;
					this.$.sizeAlt3.value = this.alterations[index].size;
					this.$.amountAlt3.value = this.alterations[index].amount;
				}
			},
			addOffer: function() {
				var offerNew = new Object();
				if(this.$.addOff1.value != null && this.$.addOff1.value != "") {
					offerNew.name = this.$.addOff1.value;
				}
				if(this.$.addOff2.value != null && this.$.addOff2.value != "") {
					offerNew.description = this.$.addOff2.value;
				}
				var startDateTime;
				var endDateTime;
				if(this.$.addOff3.value != null && this.$.addOff3.value != "") {
					startDateTime = this.$.addOff3.value;
				}
				if(this.$.addOff4.value != null && this.$.addOff4.value != "") {
					endDateTime = this.$.addOff4.value;
				}
				if(startDateTime != null && endDateTime != null) {
					offerNew.validFor = {startDateTime, endDateTime};
				} else if(startDateTime != null && endDateTime == null) {
					offerNew.validFor = {startDateTime};
				} else if(startDateTime == null && endDateTime != null) {
					offerNew.validFor = {endDateTime};
				}
				function mapPrice(item) {
					var out = new Object();
					if(item.name != null && item.name != "") {
						out.name = item.name;
					}
					if(item.description != null && item.description != "") {
						out.description = item.description;
					}
					var startDateTime;
					var endDateTime;
					if(item.start != null && item.start != "") {
						startDateTime = item.start;
					}
					if(item.end != null && item.end != "") {
						endDateTime = item.end;
					}
					if(startDateTime != null && endDateTime != null) {
						out.validFor = {startDateTime, endDateTime};
					} else if(startDateTime != null && endDateTime == null) {
						out.validFor = {startDateTime};
					} else if(startDateTime == null && endDateTime != null) {
						out.validFor = {endDateTime};
					}
					if(item.type != null && item.type != "") {
						out.priceType = item.type;
					}
					if(item.unit != null && item.unit != "") {
						out.unitOfMeasure = item.size + item.unit;
					}
					var taxIncludedAmount;
					var currencyCode;
					if(item.tax != null && item.tax != "") {
						taxIncludedAmount = item.tax;
					}
					if(item.currency != null && item.currency != "") {
						currencyCode = item.currency;
					}
					if(taxIncludedAmount != null && currencyCode != null) {
						out.price = {taxIncludedAmount, currencyCode};
					} else if (taxIncludedAmount != null && currencyCode == null) {
						out.price = {taxIncludedAmount};
					} else if (taxIncludedAmount == null && currencyCode != null) {
						out.price = {currencyCode};
					}
					if(item.period != null && item.period != "") {
						out.recurringChargePeriod = item.period;
					}
					if(item.alteration != null && item.alteration != "") {
						out.productOfferPriceAlteration = new Array();
					}
					return out; 
				}
				offerNew.productOfferingPrice = this.prices.map(mapPrice);
				this.$.addOff1.value = null;
				this.$.addOff2.value = null;
				var ajax = this.$.productAddAjax;
console.log(ajax);
				ajax.body = offerNew;
console.log(ajax.body);
				ajax.generateRequest();
			},
			checkRecure: function() {
				if(this.$.addPrice1.selected == 0) {
					this.$.addPrice5drop.disabled = false;
				} else { 
					this.$.addPrice5drop.disabled = true;
				}
			},
			addPrice: function() {
				var priceNew = new Object();
				priceNew.name = this.$.priceName.value;
				priceNew.description = this.$.addPriceDes.value;
				priceNew.start = this.$.priceStartDate.value;
				priceNew.end = this.$.priceEndDate.value;
				switch(this.$.addPrice1.selected) {
					case 0:
						priceNew.type = "recurring";
						break;
					case 1:
						priceNew.type = "one_time";
						break;
					case 2:
						priceNew.type = "usage";
				}
				priceNew.size = this.$.addPriceSize.value;
				switch(this.$.addPrice2.selected) {
					case 0:
						priceNew.unit = "b";
						break;
					case 1:
						priceNew.unit = "c";
						break;
					case 2:
						priceNew.unit = "s";
						break;
					case 3:
						priceNew.unit = "m";
						break;
					case 4:
						priceNew.unit = "g";
				}
				priceNew.tax = parseInt(this.$.addPrice3.value);
				priceNew.currency = this.$.addPrice4.value;
				switch(this.$.addPrice5.selected) {
					case 0:
						priceNew.period = "daily";
						break;
					case 1:
						priceNew.period = "weekly";
						break;
					case 2:
						priceNew.period = "monthly";
						break
					case 3:
						priceNew.period = "yearly";
				}
				priceNew.alteration = this.$.addPriceDrop.value;
				this.push('prices', priceNew);
				this.$.priceName.value = null;
				this.$.addPriceDes.value = null;
				this.$.priceStartDate.value = null;
				this.$.priceEndDate.value = null;
				this.$.addPrice1.value = null;   
				this.$.addPrice4.value = null;
				this.$.addPrice5.value = null;
			},
			addAlteration: function() {
				var altNew = new Object();
				altNew.name = this.$.addAlt1.value;
				altNew.description = this.$.descAlt2.value;
				altNew.startdate = this.$.startAlt2.value;
				altNew.terminationDate = this.$.endAlt2.value;
				altNew.type = this.$.typeAlt3.value;
				altNew.units = this.$.addUnitDrop.value;
				altNew.size= this.$.sizeAlt3.value;
				altNew.amount= this.$.amountAlt3.value;
				this.push('alterations', altNew);
				this.$.addAlt1.value = null
				this.$.descAlt2.value = null;
				this.$.startAlt2.value = null;
				this.$.endAlt2.value = null;
				this.$.typeAlt3.value = null;
				this.$.sizeAlt3.value = null;
				this.$.amountAlt3.value = null;
			},
			_onLoadingChanged: function(event) {
				if (document.getElementById("productAddAjax").loading) {
					document.getElementById("progress").disabled = false;
				} else {
					document.getElementById("progress").disabled = true;
				}
			},
			productAddResponse: function(event) {
				this.$.addProductModal.close();
				document.getElementById("getProducts").generateRequest();
			}
		});
	</script>
</dom-module>
