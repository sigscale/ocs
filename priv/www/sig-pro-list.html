<link rel="import" href="polymer/polymer.html">
<link rel="import" href="vaadin-grid/vaadin-grid.html">
<link rel="import" href="vaadin-grid/vaadin-grid-filter.html">
<link rel="import" href="vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="i18n-msg/i18n-msg-behavior.html">
<link rel="import" href="iron-ajax/iron-ajax.html">
<link rel="import" href="paper-fab/paper-fab.html" >
<link rel="import" href="paper-toast/paper-toast.html">
<link rel="import" href="paper-styles/color.html">

<dom-module id="sig-pro-list">
	<style>
		::-webkit-input-placeholder { /* Chrome/Opera/Safari */
         color: initial;
         font-weight: bold;
      }
      ::-moz-placeholder { /* Firefox 19+ */
         color: initial;
         font-weight: bold;
      }
      :-ms-input-placeholder { /* IE 10+ */
         color: initial;
         font-weight: bold;
      }
      :-moz-placeholder { /* Firefox 18- */
         color: initial;
         font-weight: bold;
      }
      .add-button {
         right: 2%;
         position: fixed;
         bottom: 5%;
         z-index: 100;
      }
      paper-fab {
         background: var(--paper-lime-a700);
         color: black;
      }
      vaadin-grid {
         height: 100%;
         --vaadin-grid-header-cell: {
            background: #ffb04c;
         };
      }
		 vaadin-grid input {
         font-size: inherit;
         background: #ffb04c;
         border-style: none;
      }
   </style>
	<template>
		<vaadin-grid id="productGrid" active-item="{{activeItem}}">
			<vaadin-grid-column width="15ex" flex-grow="5">
				<template class="header">
					<vaadin-grid-sorter path="name">
						<vaadin-grid-filter aria-label="Name" path="name" value="[[_filterName]]">
							<input placeholder="Name" value="{{_filterName::input}}" focus-target>
						</vaadin-grid-filter>
				 	</vaadin-grid-sorter>
				</template>
				<template>[[item.name]]</template>
			</vaadin-grid-column>
			<vaadin-grid-column width="15ex" flex-grow="13">
				<template class="header">
					<vaadin-grid-sorter path="description">
						<vaadin-grid-filter aria-label="Description" path="description" value="[[_filterDes]]">
							<input placeholder="Description" value="{{_filterDes::input}}" focus-target>
						</vaadin-grid-filter>
					</vaadin-grid-sorter>
				</template>
				<template>[[item.description]]</template>
			</vaadin-grid-column>
			<vaadin-grid-column width="15ex" flex-grow="10">
				<template class="header">
					<vaadin-grid-sorter path="startDate">
						<vaadin-grid-filter aria-label="StartDate" path="startDate" value="[[_filterStart]]">
							<input placeholder="Start Date" value="{{_filterStart::input}}" focus-target>
						</vaadin-grid-filter>
					</vaadin-grid-sorter>
				</template>
				<template>[[item.startDate]]</template>
			</vaadin-grid-column>
			<vaadin-grid-column width="15ex" flex-grow="10">
				<template class="header">
					<vaadin-grid-sorter path="endDate">
						<vaadin-grid-filter aria-label="EndDate" path="endDate" value="[[_filterEnd]]">
							<input placeholder="End Date" value="{{_filterEnd::input}}" focus-target>
						</vaadin-grid-filter>
					</vaadin-grid-sorter>
				</template>
				<template>[[item.endDate]]</template>
			</vaadin-grid-column>
			<vaadin-grid-column width="15ex" flex-grow="7">
				<template class="header">
					<vaadin-grid-sorter path="status">
						<vaadin-grid-filter aria-label="Status" path="status" value="[[_filterStatus]]">
							<input placeholder="Status" value="{{_filterStatus::input}}" focus-target>
						</vaadin-grid-filter>
					</vaadin-grid-sorter>
				</template>
				<template>[[item.status]]</template>
			</vaadin-grid-column>
			<vaadin-grid-column width="15ex" flex-grow="8">
				<template class="header">
					<vaadin-grid-sorter path="price">
						<vaadin-grid-filter aria-label="Prices" path="price" value="[[_filterPrice]]">
							<input placeholder="Prices" value="{{_filterPrice::input}}" focus-target>
						</vaadin-grid-filter>
					</vaadin-grid-sorter>
				</template>
				<template>[[item.price]]</template>
			</vaadin-grid-column>
		</vaadin-grid>
		<div class="add-button">
			<paper-fab
					icon="add"
					on-click="showAddProductModal">
			</paper-fab>
		</div>
		<paper-toast id="toast-successPri">
         <h2>successfully added</h2>
      </paper-toast>
		<iron-ajax id="getProducts"
			url="/productInventoryManagement/v1/product"
         headers='{"Accept": "application/json"}'
         on-response="proResponse">
      </iron-ajax>
	</template>
	<script>
		addEventListener('WebComponentsReady', function() {
			Polymer ({
				is: 'sig-pro-list',
				behaviors: [i18nMsgBehavior],
				properties: {},
				ready: function() {
					var grid = this.$.productGrid;
					grid.columns = [
						{
							name: "name"
						},
						{
							name: "description"
						},
						{
							name: "startDate"
						},
						{
							name: "endDate"
						},
						{
							name: "status"
						},
						{
							name: "price"
						}
					];
					grid.dataProvider = function(params, callback) {
                  var ajax = document.getElementById("getProducts");
                  cbPro = callback;
                  ajax.url="/productInventoryManagement/v1/product"
                  params.filters.forEach(function(filter, index) {
                     if(index == 0) {
                        ajax.url += '?'+ filter.path + '=' + filter.value;
                     } else {
                        ajax.url += '&'+ filter.path + '=' + filter.value;
                     }
                  });
                  params.sortOrders.forEach(function(sort, index) {
                     var dirsort;
                     if(sort.direction == "desc") {
                        dirsort = '-' + sort.path;
                     } else {
                        dirsort = sort.path;
                     }
                        if(index == 0) {
                           if(params.filters.length == 0) {
                              ajax.url += '?sort=' + dirsort;
                           } else {
                              ajax.url += '&sort=' + dirsort;
                           }
                        } else {
                           ajax.url += ',' + dirsort;
                     }
                  });
                  ajax.generateRequest();
               };
				},
				proResponse: function(event) {
					var grid = this.$.productGrid;
					var results = event.detail.xhr.response;
					var range = event.detail.xhr.getResponseHeader('Content-Range');
					if (range) {
                  var itemCount = range.split("/");
                  grid.size = Number(itemCount[1]);
               } else {
                  grid.size = results.length;
               }
               grid.pageSize = grid.size;
					var vaadinItems = new Array();
               for (var index in results) {
						var newRecord = new Object();
						newRecord.name = results[index].name;
						newRecord.description = results[index].description;
						if(results[index].validFor && results[index].validFor != "") {
							if(results[index].validFor.startDateTime
									&& results[index].validFor.startDateTime != ""){
								newRecord.startDate = results[index].validFor.startDateTime.split("T")[0];
							}
							if(results[index].validFor.endDateTime
									&& results[index].validFor.endDateTime != ""){
								newRecord.endDate = results[index].validFor.endDateTime.split("T")[0];
							}
						}
						newRecord.status = results[index].status;
						if(results[index].productPrice && results[index].productPrice != ""){
							function getNames(price) {
								return price.name;
							}
							newRecord.price = results[index].productPrice.map(getNames).join(", ");
						}
						vaadinItems[index] = newRecord;
					}
					cbPro(vaadinItems);
				},
				showAddProductModal: function(event) {
					var modal = document.getElementById("addProductModal");
					modal.open();
				},	
			});
		});
	</script>
</dom-module>
