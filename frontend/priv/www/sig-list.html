<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/iron-icons/notification-icons.html">
<link rel="import" href="bower_components/iron-icons/editor-icons.html">
<link rel="import" href="bower_components/iron-icon/iron-icon.html">
<link rel="import" href="bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="bower_components/paper-toast/paper-toast.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">
<link rel="import" href="bower_components/paper-fab/paper-fab.html" >
<link rel="import" href="sig-add.html">
<link rel="import" href="shared-styles.html">


<dom-module id="sig-list">

		  <template>
					 <style> /* local DOM styles go here */ 
:host { display: inline-block; }
iron-icon { fill: rgba(0,0,0,0); stroke: currentcolor; } 
:host([pressed]) iron-icon { fill: currentcolor; }
paper-button{   
		  background-color: #7d8ff5;
		  color: white;
		  font-weight: bold;}

								#subscriber{width:3%;}
					 </style>
					 <div>	
								<paper-toolbar>
													<paper-fab icon="add" on-click = "showAddModal"></paper-fab>
								</paper-toolbar>
					 </div>
					 <style include="shared-styles">
:host {
		  display: block;
		  padding: 10px;
}
						paper-fab { 
								  --paper-fab-background: #7d8ff5;
								  --paper-fab-keyboard-focus-background: var(--paper-light-blue-900); }
						vaadin-grid{font-size: 16px;}
					 </style>

					 <paper-dialog id="modal1" modal style="width:60%;">
								<h1>Edit Subscriber</h1>
								  <div id="form" >
										 <paper-input id="edit-id" name="subscriber" label="Identity" disabled></paper-input>
										 <paper-input id="edit-pwd" name="password"  label="Secret" disabled ></paper-input>
										 <paper-input id="edit-new-pwd" name="newpassword" label="New Secret" required auto-validate error-message="New secret can't be empty!" ></paper-input>
										 <div class="buttons">
									    <paper-button dialog-confirm autofocus on-click="editSelectedItems">Edit</paper-button>
									    <paper-button on-click="cancel" >Cancel</paper-button>
										<paper-button toggles raised on-click = "deleteSeletedItems"  > Delete </paper-button>
										 </div>
									</div>
					 </paper-dialog>

					 <paper-dialog id="modal2" modal style="width:60%; height:50%;">
								<sig-add></sig-add>
					 </paper-dialog>

					 <vaadin-grid selection-mode="single" id="frozen" frozen-columns="2" on-selected-items-changed="onSelect">
								<table>
										  <colgroup> 
													 <col name="identity"/> 
													 <col name="password"/> 
													 <col name="balance"/> 
													 <col name="ascend-data-rate.value"/>
													 <col name="ascend-xmit-rate.value"/>
													 <col name="session-timeout"/>
													 <col name="acct-interim-interval"/>
													 <col name="class"/>
													 <col name="enabled"/> 
										  </colgroup>
										  <thead>
													 <tr>
																<th>Identity</th>
																<th>Secret</th>
																<th>Balance</th>
																<th>Receive Data Rate</th>
																<th>Transmit Data Rate</th>
																<th>Session Timeout</th>
																<th>Update Interval</th>
																<th>Class</th>
																<th>Enabled</th>
													 </tr>
										  </thead>
								</table>


					 </vaadin-grid>

					 <paper-toast id="edit-toast">
								<h2>Subscriber sucessfully updated !</h2>
					 </paper-toast>

					 <paper-toast id="delete-toast">
								<h2>Subscriber sucessfully deleted !</h2>
					 </paper-toast>

					 <iron-ajax id="getSubs"
					 				auto=false
									url="http://localhost:8888/ocs/subscriber"
									headers='{"Accept": "application/json"}'
									on-response="responseHandler"
									debounce-duration="10"> </iron-ajax>

					 <iron-ajax id="editSub"
					 				auto=true
									headers='{"Accept": "application/json"}'
									on-response="editResponseHandler"
									debounce-duration="300"> </iron-ajax>
					 
					 <iron-ajax	 id="deleteSubs"
									 auto
									 handle-as="json"
			 						 method = "delete"
									 on-response="deletionResponse"
									 debounce-duration="300"> </iron-ajax>

		  </template>

		  <script>
Polymer({
		  is: 'sig-list',

		  properties:{
					 onLoadItemsChnaged:{type: Boolean, value: true}
		  },
			
		  listners: {
		  },

		  created: function() {
		  },

		  ready: function() {
		  },

		  responseHandler: function(event) {
					 var grid = this.$.frozen; 
					 grid.items = event.detail.xhr.response;
					 this.onLoadItemsChnaged = false;
					 console.log(this.onLoadItemsChnaged);
					 console.log("gets to here");
		  },

		  gotoEnd: function(event){
					 var grid = this.$.frozen; 
					 grid.scrollToEnd();
		  },

		  showAddModal: function(event){
					 var modal = this.$.modal2; 
					 modal.open(); 
					 this.onLoadItemsChnaged = true;
		  },

		  editSelectedItems: function(event){
					 var editAjax =  document.getElementById("editSub");
					 editAjax.method = "PUT";
					 editAjax.contentType = "application/json";
					 var id = document.getElementById("edit-id").value;
					 editAjax.url = "http://localhost:8888/ocs/subscriber/" + id;
					 var sub = new Object();
					 sub.update = "password";
					 sub.newpassword = document.getElementById("edit-new-pwd").value;
					 editAjax.body = sub;
					 this.onLoadItemsChnaged = true;
		  },

		  editResponseHandler: function (){
					 if(event.detail.succeeded){
						document.getElementById("edit-toast").open();
					 	document.getElementById("edit-new-pwd").value = "";
					 	var getSubsAjax = document.getElementById("getSubs");
						getSubsAjax.generateRequest();
					 }
					 else{
								console.log("Not Success");
					 }
		  },
		  
		  cancel: function(){
					 this.$.modal1.close();
		  },

		  deleteSeletedItems: function(event){
					 var grid = this.$.frozen; 
					 grid.selection.selected(function(index)
										  { var selection = grid.items[index];
											 var deleteAjax = document.getElementById("deleteSubs");
											 deleteAjax.url = "http://localhost:8888/ocs/subscriber/"+ selection.identity;
											 deleteAjax.generateRequest();
										  });
		  },

		  deletionResponse: function(event){
					 this.onLoadItemsChnaged = true;
					 this.$.modal1.close(); 
					 document.getElementById("delete-toast").open();
					 var getSubsAjax = document.getElementById("getSubs");
					 getSubsAjax.generateRequest();
		  },

		  onSelect: function(event) {
					 if(!this.onLoadItemsChnaged){
					 		var grid = this.$.frozen; 
					 		var modal = this.$.modal1; 
							modal.open();
					 		grid.selection.selected(function(index)
										  { var selection = grid.items[index];
											 document.getElementById("edit-id").value = selection.identity;
											 document.getElementById("edit-pwd").value = selection.password;
										  });
					 }
					 
		  }
});
		  </script>
</dom-module>
